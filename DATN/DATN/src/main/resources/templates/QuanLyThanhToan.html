
<link rel="stylesheet" href="/css/Style_QuanLyThanhToan.css">

	<!-- ========== MAIN CONTAINER ========== -->
	<div class="container-admin">


		<h2>Qu·∫£n l√Ω thanh to√°n</h2>
		<table
			class="table table-bordered table-hover text-center align-middle">
			<thead class="table-dark">
				<tr>
					<th>M√£ TT</th>
					<th>M√£ ƒêH</th>
					<th>S·ªë Ti·ªÅn</th>
					<th>Ng√†y TT</th>
					<th>Ph∆∞∆°ng Th·ª©c</th>
					<th>Tr·∫°ng Th√°i</th>
					<th>Ghi Ch√∫</th>
					<th>H√†nh ƒë·ªông</th>
				</tr>
			</thead>
			<tbody>
				<tr th:each="tt : ${listThanhToan}">
					<td th:text="'TT' + ${tt.maThanhToan}"></td>
					<td th:text="'DH' + ${tt.donHang.maDH}"></td>
					<td
						th:text="${#numbers.formatDecimal(tt.soTien, 0, 'COMMA', 0, 'POINT')} + '‚Ç´'"></td>

					<!-- ‚úÖ Fix d√≤ng n√†y -->
					<td th:text="${#temporals.format(tt.ngayThanhToan, 'yyyy-MM-dd')}"></td>

					<td th:text="${tt.phuongThucTT}"></td>
					<td
						th:classappend="${tt.trangThai == 'ƒê√£ thanh to√°n' ? 'status-paid' : 'status-unpaid'}"
						th:text="${tt.trangThai}"></td>
					<td class="note-cell" th:attr="title=${tt.ghiChuTT}"
						th:text="${tt.ghiChuTT}"></td>
					<td>
						<button class="btn btn-warning btn-sm"
							onclick="showEditForm(this)">S·ª≠a</button>
						<button class="btn btn-danger btn-sm">X√≥a</button>
					</td>
				</tr>
			</tbody>


		</table>








		<!-- FORM CH·ªàNH S·ª¨A TH√îNG TIN THANH TO√ÅN -->
		<div id="editForm" class="mt-5 p-4 border rounded bg-white shadow"
			style="display: none;">
			<h4 class="mb-3">Ch·ªânh s·ª≠a thanh to√°n</h4>
			<form id="paymentEditForm">
				<div class="row g-3">
					<div class="col-md-4">
						<label for="maTT" class="form-label">M√£ Thanh To√°n</label> <input
							type="text" class="form-control" id="maTT" readonly>
					</div>
					<div class="col-md-4">
						<label for="maDH" class="form-label">M√£ ƒê∆°n H√†ng</label> <input
							type="text" class="form-control" id="maDH">
					</div>
					<div class="col-md-4">
						<label for="soTien" class="form-label">S·ªë Ti·ªÅn</label> <input
							type="number" class="form-control" id="soTien">
					</div>
					<div class="col-md-4">
						<label for="ngayTT" class="form-label">Ng√†y Thanh To√°n</label> <input
							type="date" class="form-control" id="ngayTT">
					</div>
					<div class="col-md-4">
						<label for="phuongThuc" class="form-label">Ph∆∞∆°ng Th·ª©c TT</label>
						<select class="form-select" id="phuongThuc">
							<option value="COD">COD</option>
							<option value="Chuy·ªÉn kho·∫£n">Chuy·ªÉn kho·∫£n</option>
						</select>
					</div>
					<div class="col-md-4">
						<label for="trangThai" class="form-label">Tr·∫°ng Th√°i</label> <select
							class="form-select" id="trangThai">
							<option value="ƒê√£ thanh to√°n">ƒê√£ thanh to√°n</option>
							<option value="ƒêang x·ª≠ l√Ω">ƒêang x·ª≠ l√Ω</option>
							<option value="Th·∫•t b·∫°i">Th·∫•t b·∫°i</option>
						</select>
					</div>
					<div class="col-12">
						<label for="ghiChu" class="form-label">Ghi Ch√∫</label>
						<textarea class="form-control" id="ghiChu" rows="2"></textarea>
					</div>
				</div>
				<div class="mt-4 d-flex justify-content-end">
					<button type="button" class="btn btn-secondary me-2"
						onclick="hideEditForm()">H·ªßy</button>
					<button type="submit" class="btn btn-primary">L∆∞u thay ƒë·ªïi</button>
				</div>
			</form>
		</div>

	</div>

	<!-- SCRIPT x·ª≠ l√Ω s·ª± ki·ªán S·ª≠a -->
	<script>
  function showEditForm(button) {
  const row = button.closest("tr");
  document.getElementById("editForm").style.display = "block";

  document.getElementById("maTT").value = row.children[0].innerText;
  document.getElementById("maDH").value = row.children[1].innerText;

  // üëâ S·ª≠a d√≤ng n√†y:
  const soTienRaw = row.children[2].innerText.replace(/[^0-9]/g, '');
  document.getElementById("soTien").value = parseInt(soTienRaw);

  document.getElementById("ngayTT").value = row.children[3].innerText;

  document.getElementById("phuongThuc").value = row.children[4].innerText.trim();
  document.getElementById("trangThai").value = row.children[5].innerText.trim();
  document.getElementById("ghiChu").value = row.children[6].innerText;
}

  function hideEditForm() {
    document.getElementById("editForm").style.display = "none";
  }

  // Khi submit form
  document.getElementById("paymentEditForm").addEventListener("submit", function (e) {
    e.preventDefault();
    alert("Th√¥ng tin thanh to√°n ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t (gi·∫£ l·∫≠p)");
    hideEditForm();
    // TODO: G·ª≠i request c·∫≠p nh·∫≠t v√†o DB
  });
</script>

	<script>
  function showEditForm(button) {
    const row = button.closest("tr");
    document.getElementById("editForm").style.display = "block";

    document.getElementById("maTT").value = row.children[0].innerText.replace("TT", "");
    document.getElementById("maDH").value = row.children[1].innerText.replace("DH", "");

    const soTienRaw = row.children[2].innerText.replace(/[^0-9]/g, '');
    document.getElementById("soTien").value = parseInt(soTienRaw);

    document.getElementById("ngayTT").value = row.children[3].innerText;
    document.getElementById("phuongThuc").value = row.children[4].innerText.trim();
    document.getElementById("trangThai").value = row.children[5].innerText.trim();
    document.getElementById("ghiChu").value = row.children[6].innerText;
  }

  function hideEditForm() {
    document.getElementById("editForm").style.display = "none";
  }

  document.getElementById("paymentEditForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const data = {
      maThanhToan: document.getElementById("maTT").value,
      maDH: document.getElementById("maDH").value,
      soTien: document.getElementById("soTien").value,
      ngayThanhToan: document.getElementById("ngayTT").value,
      phuongThuc: document.getElementById("phuongThuc").value,
      trangThai: document.getElementById("trangThai").value,
      ghiChu: document.getElementById("ghiChu").value
    };

    fetch("/ThanhToan/update", {
      method: "POST",
      headers: {
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: new URLSearchParams(data)
    })
    .then(response => response.text())
    .then(res => {
      if (res === "success") {
        alert("C·∫≠p nh·∫≠t th√†nh c√¥ng!");
        location.reload();
      } else {
        alert("L·ªói c·∫≠p nh·∫≠t!");
      }
    });
  });

  // X√ìA
  document.querySelectorAll(".btn-danger").forEach(btn => {
    btn.addEventListener("click", function () {
      if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a thanh to√°n n√†y kh√¥ng?")) {
        const row = this.closest("tr");
        const maTT = row.children[0].innerText.replace("TT", "");

        fetch("/ThanhToan/delete", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: "maThanhToan=" + maTT
        })
        .then(response => response.text())
        .then(res => {
          if (res === "success") {
            alert("X√≥a th√†nh c√¥ng!");
            location.reload();
          } else {
            alert("L·ªói x√≥a!");
          }
        });
      }
    });
  });
</script>




</body>
</html>
