<link rel="stylesheet" href="/css/xacnhan.css" />

<div id="content" class="order-confirm-container" style="display: none;">
	<th:block th:each="dh, iterStat : ${donHang}">
		<div class="order-header">
			<h4>üõí X√°c nh·∫≠n ƒë∆°n h√†ng</h4>
			<p>
				M√£ ƒë∆°n h√†ng: <strong th:text="'DH' + ${dh.donHang.maDH}"></strong>
			</p>
		</div>

		<th:block th:each="ct, iterStat : ${dh.chiTietDonHangs}">
			<div class="order-item">
				<div class="order-item-info">
					<img
						th:src="@{${ ct.bienTheSanPham != null and !#lists.isEmpty(ct.bienTheSanPham.anhChiTietList) 
					 ? ct.bienTheSanPham.anhChiTietList[0].urlAnhCT : (!#lists.isEmpty(ct.bienTheSanPham.sanPham.anhSanPham) 
					 ? ct.bienTheSanPham.sanPham.anhSanPham[0].urlAnhSP  : '/img/default.png') } }"
						alt="product">
					<div>
						<h6 th:text="${ct.bienTheSanPham.sanPham.tenSP}"></h6>
						<p th:text="'S·ªë l∆∞·ª£ng: ' + ${ct.soLuongSP}"></p>
						<p>
							<strong><span th:if="${ct.giamGiaThucTe == 0}">
									Th√†nh ti·ªÅn: <span style="color: red;"
									th:text="${#numbers.formatDecimal(ct.thanhTien, 0, 'POINT', 0, 'COMMA')} + ' VND'"></span>

							</span> <span th:if="${ct.giamGiaThucTe > 0}"> ƒê∆°n gi√°: <span
									th:text="${#numbers.formatDecimal(ct.donGia, 0, 'POINT', 0, 'COMMA')} + ' VND'"></span>
									| Gi·∫£m gi√°: <span
									th:text="${#numbers.formatDecimal(ct.giamGiaThucTe, 0, 'POINT', 0, 'COMMA')} + ' VND'"></span>
									| Th√†nh ti·ªÅn: <span style="color: red;"
									th:text="${#numbers.formatDecimal(ct.thanhTien, 0, 'POINT', 0, 'COMMA')} + ' VND'"></span>

							</span></strong>
						</p>
					</div>
				</div>
    <!-- n√∫t b√°o l·ªói: l∆∞u data-maDH v√† data-maCTDH (kho√° ch√≠nh chi ti·∫øt ƒë∆°n) -->
<th:block th:if="${doneMaCTDH != ct.maCTDH}">
    <button type="button"
            class="btn btn-outline-danger btn-sm btn-report-product"
            th:attr="data-madh=${dh.donHang.maDH}, data-mactdh=${ct.maCTDH}">
      üö© B√°o l·ªói
    </button>
</th:block>

<th:block th:if="${doneMaCTDH == ct.maCTDH}">
    <button type="button"
            class="btn btn-success btn-sm"
            disabled>
      ‚úÖ Ho√†n th√†nh
    </button>
</th:block>

			</div>

		</th:block>
		<div class="mt-3">
			<p>
				<strong
					th:text="'Ph√≠ v·∫≠n chuy·ªÉn: ' + ${#numbers.formatDecimal(dh.donHang.phiVanChuyen, 0, 'POINT', 0, 'COMMA')} + ' VND'"></strong>
			</p>
			<h5>
				<strong> T·ªïng thanh to√°n: <span style="color: red;"
					th:text="${#numbers.formatDecimal(dh.donHang.thanhTien, 0, 'POINT', 0, 'COMMA')} + ' VND'">
				</span>
				</strong>
			</h5>

		</div>

		<!-- N√∫t h√†nh ƒë·ªông -->
		<div class="order-actions">
			<button class="btn" style="background-color: #dc3545; color: #fff;"
				onclick="goBack1()">‚ùå H·ªßy</button>
<button type="button"
        class="btn btn-danger btn-report-order"
        th:attr="data-madh=${dh.donHang.maDH}">
  ‚ö†Ô∏è B√°o l·ªói ƒë∆°n h√†ng
</button>
			<form th:action="@{/xac-nhan-nhan-hang}" method="post"
				th:id="'form-xac-nhan-' + ${dh.donHang.maDH}" style="margin: 0;">
				<input type="hidden" th:name="${_csrf.parameterName}"
					th:value="${_csrf.token}" /> <input type="hidden" name="maDH"
					th:value="${dh.donHang.maDH}" />
				<button class="btn-xac-nhan-nhan-hang" 
					style="background-color: #28a745; color: #fff;"
					th:data-id="'form-xac-nhan-' + ${dh.donHang.maDH}">‚úÖ X√°c
					nh·∫≠n ƒë∆°n h√†ng</button>
			</form>
		</div>
	</th:block>
<!-- backdrop -->
<div id="reportModalOverlay" class="modal-overlay2" aria-hidden="true">
  <div class="modal-box2" role="dialog" aria-modal="true" aria-labelledby="reportTitle">
    <h4 id="reportTitle">B√°o l·ªói</h4>

    <!-- form submit b√¨nh th∆∞·ªùng t·ªõi /bao-loi -->
    <form id="reportForm" th:action="@{/bao-loi}" method="post" enctype="multipart/form-data" novalidate>
      <!-- CSRF -->
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
      <input type="hidden" name="token" th:value="${token}" />

      <!-- hidden fields -->
      <input type="hidden" name="maDH" id="reportMaDH" />
      <input type="hidden" name="maCTDH" id="reportMaCTDH" />

      <div class="form-group2">
        <label for="ghiChu">Ghi ch√∫ (m√¥ t·∫£ l·ªói)</label>
        <textarea name="ghiChu" id="ghiChu" class="form-control2" rows="4" placeholder="M√¥ t·∫£ chi ti·∫øt l·ªói, t√¨nh tr·∫°ng s·∫£n ph·∫©m..."></textarea>
      </div>

      <div class="form-group2">
        <label for="files">·∫¢nh / Video ch·ª©ng minh</label>
        <input type="file" name="files" id="files" class="form-control2" multiple accept="image/*,video/*" />
        <small style="color:#666">H·ªó tr·ª£ nhi·ªÅu file. ·∫¢nh/Video s·∫Ω gi√∫p x·ª≠ l√Ω nhanh h∆°n.</small>
      </div>

      <div class="modal-actions2">
        <button type="button" class="btn2 btn-secondary2" onclick="closeReportModal()">ƒê√≥ng</button>
        <button type="submit" class="btn2 btn-danger2">G·ª≠i b√°o l·ªói</button>
      </div>
    </form>
  </div>
</div>

</div>


<script>
document.addEventListener("DOMContentLoaded", () => {
    const container = document.getElementById("content");
    if (!container) return;

    const overlay = document.getElementById('reportModalOverlay');
    const modalBox = overlay ? overlay.querySelector('.modal-box') : null;
    const reportForm = document.getElementById('reportForm');
    const inputMaDH = document.getElementById('reportMaDH');
    const inputMaCTDH = document.getElementById('reportMaCTDH');
    const inputGhiChu = document.getElementById('ghiChu');
    const inputFiles = document.getElementById('files');
    const titleEl = document.getElementById('reportTitle');

    // Click delegation cho t·∫•t c·∫£ n√∫t trong container
    container.addEventListener('click', (e) => {
		
        const btnConfirm = e.target.closest(".btn-xac-nhan-nhan-hang");
        if (btnConfirm) {
            e.preventDefault();
            const formId = btnConfirm.getAttribute("data-id");
            if (!formId) return;
            showConfirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√°c nh·∫≠n ƒë∆°n h√†ng n√†y?", () => {
                const form = document.getElementById(formId);
                if (form) form.submit();
            });
            return;
        }

        // N√∫t b√°o l·ªói s·∫£n ph·∫©m / ƒë∆°n h√†ng
        const btnReport = e.target.closest(".btn-report-product, .btn-report-order");
        if (btnReport) {
            e.preventDefault();

            const maDH = btnReport.dataset.madh || '';
            const maCTDH = btnReport.dataset.mactdh || '';

            // Reset modal
            inputMaDH.value = maDH;
            inputMaCTDH.value = maCTDH || '';
            inputGhiChu.value = '';
            if (inputFiles) inputFiles.value = null;
            titleEl.textContent = maCTDH ? 'B√°o l·ªói s·∫£n ph·∫©m' : 'B√°o l·ªói ƒë∆°n h√†ng';

            // Show overlay
            if (overlay) {
                overlay.classList.add('open');
                overlay.setAttribute('aria-hidden','false');
                setTimeout(()=> inputGhiChu.focus(), 120);
            }
            return;
        }

    });

    // ƒê√≥ng modal khi click ngo√†i modal-box
    if (overlay) {
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) closeReportModal();
        });
    }

    // Kh√¥ng bubble click trong modal-box
    if (modalBox) {
        modalBox.addEventListener('click', (e) => {
            e.stopPropagation();
        });
    }

    // ESC ƒë√≥ng modal
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && overlay && overlay.classList.contains('open')) {
            closeReportModal();
        }
    });

    // Function ƒë√≥ng modal
    function closeReportModal() {
        if (!overlay) return;
        overlay.classList.remove('open');
        overlay.setAttribute('aria-hidden', 'true');
    }
    window.closeReportModal = closeReportModal;

    // Form b√°o l·ªói submit gi·ªØ m·∫∑c ƒë·ªãnh
    if (reportForm) {
        reportForm.addEventListener('submit', (e) => {
            // N·∫øu mu·ªën confirm tr∆∞·ªõc khi g·ª≠i: uncomment
            // if (!confirm('B·∫°n ch·∫Øc ch·∫Øn g·ª≠i b√°o l·ªói?')) { e.preventDefault(); return; }
            // Browser s·∫Ω submit b√¨nh th∆∞·ªùng multipart/form-data
        });
    }

    // Token verify hi·ªÉn th·ªã n·ªôi dung
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');
    const maDH = params.get('maDH');

    function goBackOrHome() {
        if (document.referrer) {
            window.history.back();
        } else {
            window.location.href = '/';
        }
    }

    if (!token || !maDH) {
        goBackOrHome();
        return;
    }

    fetch(`/verify-token?token=${token}&maDH=${maDH}`)
    .then(async res => {
        console.log("verify-token status:", res.status);
        if (res.ok) {
            console.log("Token h·ª£p l·ªá, hi·ªÉn th·ªã n·ªôi dung");
            container.style.display = 'block';
        } else {
            let errText = await res.text();
            console.warn("Token kh√¥ng h·ª£p l·ªá ho·∫∑c l·ªói server:", errText);
            goBackOrHome();
        }
    })
    .catch(err => {
        console.error("L·ªói khi g·ªçi verify-token:", err);
        goBackOrHome();
    });

});
</script>
<script>
function goBack1() {
    window.location.href = '/'; // Lu√¥n v·ªÅ trang ch·ªß
}
</script>
