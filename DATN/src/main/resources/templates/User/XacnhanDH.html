<link rel="stylesheet" href="/css/xacnhan.css" />

<div id="content" class="order-confirm-container" style="display: none;">
	<th:block th:each="dh, iterStat : ${donHang}">
		<div class="order-header">
			<h4>üõí X√°c nh·∫≠n ƒë∆°n h√†ng</h4>
			<p>
				M√£ ƒë∆°n h√†ng: <strong th:text="'DH' + ${dh.donHang.maDH}"></strong>
			</p>
		</div>

		<th:block th:each="ct, iterStat : ${dh.chiTietDonHangs}">
			<div class="order-item">
				<div class="order-item-info">
					<img
						th:src="@{${ ct.bienTheSanPham != null and !#lists.isEmpty(ct.bienTheSanPham.anhChiTietList) 
					 ? ct.bienTheSanPham.anhChiTietList[0].urlAnhCT : (!#lists.isEmpty(ct.bienTheSanPham.sanPham.anhSanPham) 
					 ? ct.bienTheSanPham.sanPham.anhSanPham[0].urlAnhSP  : '/img/default.png') } }"
						alt="product">
					<div>
						<h6 th:text="${ct.bienTheSanPham.sanPham.tenSP}"></h6>
						<p th:text="'S·ªë l∆∞·ª£ng: ' + ${ct.soLuongSP}"></p>
						<p>
							<strong><span th:if="${ct.giamGiaThucTe == 0}">
									Th√†nh ti·ªÅn: <span style="color: red;"
									th:text="${#numbers.formatDecimal(ct.thanhTien, 0, 'POINT', 0, 'COMMA')} + ' VND'"></span>

							</span> <span th:if="${ct.giamGiaThucTe > 0}"> ƒê∆°n gi√°: <span
									th:text="${#numbers.formatDecimal(ct.donGia, 0, 'POINT', 0, 'COMMA')} + ' VND'"></span>
									| Gi·∫£m gi√°: <span
									th:text="${#numbers.formatDecimal(ct.giamGiaThucTe, 0, 'POINT', 0, 'COMMA')} + ' VND'"></span>
									| Th√†nh ti·ªÅn: <span style="color: red;"
									th:text="${#numbers.formatDecimal(ct.thanhTien, 0, 'POINT', 0, 'COMMA')} + ' VND'"></span>

							</span></strong>
						</p>
					</div>
				</div>
				<button class="btn btn-outline-danger btn-sm"
					onclick="reportIssue('DH123456', 'Gundam RX-78-2 Master Grade')">üö©
					B√°o l·ªói</button>
			</div>

		</th:block>
		<div class="mt-3">
			<p>
				<strong
					th:text="'Ph√≠ v·∫≠n chuy·ªÉn: ' + ${#numbers.formatDecimal(dh.donHang.phiVanChuyen, 0, 'POINT', 0, 'COMMA')} + ' VND'"></strong>
			</p>
			<h5>
				<strong> T·ªïng thanh to√°n: <span style="color: red;"
					th:text="${#numbers.formatDecimal(dh.donHang.thanhTien, 0, 'POINT', 0, 'COMMA')} + ' VND'">
				</span>
				</strong>
			</h5>

		</div>

		<!-- N√∫t h√†nh ƒë·ªông -->
		<div class="order-actions">
			<button class="btn" style="background-color: #dc3545; color: #fff;"
				onclick="goBack()">‚ùå H·ªßy</button>
			<button class="btn btn-danger" onclick="reportOrderIssue('DH123456')">‚ö†Ô∏è
				B√°o l·ªói ƒë∆°n h√†ng</button>
			<form th:action="@{/xac-nhan-nhan-hang}" method="post"
				th:id="'form-xac-nhan-' + ${dh.donHang.maDH}" style="margin: 0;">
				<input type="hidden" th:name="${_csrf.parameterName}"
					th:value="${_csrf.token}" /> <input type="hidden" name="maDH"
					th:value="${dh.donHang.maDH}" />
				<button class="btn-xac-nhan-nhan-hang" type="button"
					style="background-color: #28a745; color: #fff;"
					th:data-id="'form-xac-nhan-' + ${dh.donHang.maDH}">‚úÖ X√°c
					nh·∫≠n ƒë∆°n h√†ng</button>
			</form>
		</div>
	</th:block>
</div>


<script>
document.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');
    // const maThongBao = params.get('maThongBao'); // B·ªè v√¨ kh√¥ng d√πng n·ªØa
    const maDH = params.get('maDH'); // L·∫•y maDH ƒë·ªÉ d√πng n·∫øu c·∫ßn

    function goBackOrHome() {
        if (document.referrer) {
            window.history.back();
        } else {
            window.location.href = '/';
        }
    }

    // Ch·ªâ ki·ªÉm tra token v√† maDH th√¥i, kh√¥ng c·∫ßn maThongBao n·ªØa
    if (!token || !maDH) {
        goBackOrHome();
        return;
    }

    fetch(`/verify-token?token=${token}&maDH=${maDH}`)
    .then(async res => {
        console.log("verify-token status:", res.status);
        if (res.ok) {
            console.log("Token h·ª£p l·ªá, hi·ªÉn th·ªã n·ªôi dung");
            document.getElementById('content').style.display = 'block';
            // loadOrderDetails(maDH); // g·ªçi h√†m load chi ti·∫øt ƒë∆°n h√†ng n·∫øu c√≥
        } else {
            let errText = await res.text();
            console.warn("Token kh√¥ng h·ª£p l·ªá ho·∫∑c l·ªói server:", errText);
            goBackOrHome();
        }
    })
    .catch(err => {
        console.error("L·ªói khi g·ªçi verify-token:", err);
        goBackOrHome();
    });

});




</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const btnsXoa = document.querySelectorAll(".btn-xac-nhan-nhan-hang");

    btnsXoa.forEach(btn => {
        btn.addEventListener("click", () => {
            const formId = btn.getAttribute("data-id");

            showConfirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√°c nh·∫≠n ƒë∆°n h√†ng n√†y?", () => {
                document.getElementById(formId).submit();
            });
        });
    });
});
</script>