
<link rel="stylesheet" href="/css/style_TrangCaNhan.css" />

<div class="container">
	<!-- Sidebar -->
	<div class="sidebar">
		<div class="user-info">

			<img style="margin-left: 75px" th:src="${avatar}" alt="Avatar"
				onerror="this.onerror=null; this.src='/img/Screenshot_2025-06-19_220523-removebg-preview.png';">
			<strong th:text="${tendn}"></strong> <a th:href="@{/TrangCaNhan}">✎
				Sửa Hồ Sơ</a>
		</div>
		<ul>
			<li><a th:href="@{/TrangCaNhan}">Tài Khoản Của Tôi</a></li>
			<li><a th:href="@{/DiaChi}">Địa Chỉ</a></li>

			<li><a th:href="@{/Doimatkhau}">Đổi Mật Khẩu</a></li>

			<li><a th:href="@{/DonHang}" class="active">Đơn Mua</a></li>
		</ul>
	</div>



	<!-- Content -->
	<!-- Content -->
	<div class="content">
		<h2>Đơn hàng của tôi</h2>

		<!-- Bộ lọc trạng thái -->
		<div class="filter">
			<a th:href="@{/DonHang}">
				<button class="btn"
					th:classappend="${trangThai == null} ? ' active'">Tất cả</button>
			</a> <a th:href="@{/DonHang(trangThai=1)}">
				<button class="btn" th:classappend="${trangThai == 1} ? ' active'">Chờ
					xác nhận</button>
			</a> <a th:href="@{/DonHang(trangThai=2)}">
				<button class="btn" th:classappend="${trangThai == 2} ? ' active'">Chờ
					lấy hàng</button>
			</a> <a th:href="@{/DonHang(trangThai=3)}">
				<button class="btn" th:classappend="${trangThai == 3} ? ' active'">Đang
					giao</button>
			</a> <a th:href="@{/DonHang(trangThai=4)}">
				<button class="btn" th:classappend="${trangThai == 4} ? ' active'">Đã
					giao</button>
			</a> <a th:href="@{/DonHang(trangThai=6)}">
				<button class="btn" th:classappend="${trangThai == 6} ? ' active'">Hoàn
					thành</button>
			</a> <a th:href="@{/DonHang(trangThai=5)}">
				<button class="btn" th:classappend="${trangThai == 5} ? ' active'">Đã
					hủy</button>
			</a> <a th:href="@{/DonHang(trangThai=7)}">
				<button class="btn" th:classappend="${trangThai == 7} ? ' active'">Trả
					hàng/Hoàn tiền</button>
			</a>
		</div>




		<th:block th:each="dh : ${dsDonHang}">
			<div class="order">
				<div class="order-head">
					<div>
						Mã đơn: <strong th:text="'DH' + ${dh.donHang.maDH}"></strong>
					</div>
					<div>
						Trạng thái: <strong th:text="${dh.donHang.trangThaiDH.tenTTDH}"></strong>
					</div>
				</div>
				<th:block th:each="ct : ${dh.chiTietDonHangs}">
					<div class="order-items"
						style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; padding: 10px 0;">

						<div class="item1"
							style="display: flex; gap: 10px; align-items: center;">
							<img
								th:src="@{${
                        ct.bienTheSanPham != null 
                        and !#lists.isEmpty(ct.bienTheSanPham.anhChiTietList) 
                        ? ct.bienTheSanPham.anhChiTietList[0].urlAnhCT 
                        : (!#lists.isEmpty(ct.bienTheSanPham.sanPham.anhSanPham) 
                            ? ct.bienTheSanPham.sanPham.anhSanPham[0].urlAnhSP 
                            : '/img/default.png')
                    }
                }"
								alt="product"
								style="width: 80px; height: 80px; object-fit: cover; border-radius: 6px;" />

							<div class="item-info">
								<p th:text="${ct.bienTheSanPham.sanPham.tenSP}"
									style="font-weight: 500;"></p>
								<p>
									Số lượng: <span th:text="${ct.soLuongSP}"></span> | <span
										th:if="${ct.giamGiaThucTe == 0}"> Thành tiền: <span
										style="color: red;"
										th:text="${#numbers.formatDecimal(ct.thanhTien, 0, 'POINT', 0, 'COMMA')} + ' đ'"></span>
									</span> <span th:if="${ct.giamGiaThucTe > 0}"> Đơn giá: <span
										th:text="${#numbers.formatDecimal(ct.donGia, 0, 'POINT', 0, 'COMMA')} + ' đ'"></span>
										| Giảm giá: <span
										th:text="${#numbers.formatDecimal(ct.giamGiaThucTe, 0, 'POINT', 0, 'COMMA')} + ' đ'"></span>
										| Thành tiền: <span style="color: red;"
										th:text="${#numbers.formatDecimal(ct.thanhTien, 0, 'POINT', 0, 'COMMA')} + ' đ'"></span>
									</span>
								</p>
								<p>
									Phí vận chuyển: <span style="color: red;"
										th:text="${#numbers.formatDecimal(dh.donHang.phiVanChuyen, 0, 'POINT', 0, 'COMMA')} + ' đ'"></span>
								</p>
							</div>
						</div>

						<!-- Nút mua lại bên phải -->
						<div class="buy-again">
							<a href="javascript:void(0);" 
							   class="buy-again-btn"
							   th:attr="data-mact=${ct.bienTheSanPham.maCTSP}, data-soluong=1"
							   th:if="${dh.chiTietDonHangs.?[bienTheSanPham != null].size() > 0 
							           and (dh.donHang.trangThaiDH.maTTDH == 5 or dh.donHang.trangThaiDH.maTTDH == 6)}"
							   style="padding: 8px 15px; background-color: #007bff; color: white; border-radius: 6px; text-decoration: none; font-weight: 500;">
							   Mua lại
							</a>

						</div>
					</div>
				</th:block>

				<div class="order-foot"
					style="font-size: 18px; display: flex; justify-content: space-between; align-items: center;">
					<form action="">
						<button th:if="${dh.donHang.trangThaiDH.maTTDH == 1}"
							style="margin-right: 0;" class="btn btn-danger btn-huy-don"
							th:attr="data-madh=${dh.donHang.maDH}" type="button">
							Hủy đơn</button>
					</form>


					<span> Tổng tiền: <span
						th:text="${#numbers.formatDecimal(dh.donHang.thanhTien, 0, 'POINT', 0, 'COMMA')} + ' đ'"></span>
					</span>
				</div>
			</div>
		</th:block>
	</div>
</div>

<!-- Modal nhập lý do hủy -->
<div id="popupLyDoHuy" class="modal1">
	<div class="modal-content1">
		<span class="close1">&times;</span>
		<p style="font-size: 24px; font-weight: bold;">Nhập lý do hủy đơn</p>
		<form id="formLyDoHuy" method="post" th:action="@{/DonHang/huy}"
			onsubmit="return prepareLyDoHuy()" style="font-size: 16px;">
			<input type="hidden" name="maDH" id="maDHInput" value="" />

			<p style="margin-top: 10px;">Chọn lý do hủy (có thể chọn nhiều):</p>
			<div style="margin-top: 5px;">
				<label><input type="checkbox" name="lyDoMau"
					value="Thay đổi ý định mua hàng" /> Thay đổi ý định mua hàng,
					không muốn tiếp tục đặt</label><br /> <label><input type="checkbox"
					name="lyDoMau" value="Phát hiện lỗi thông tin đơn hàng" /> Phát
					hiện sai sót hoặc lỗi thông tin trong đơn hàng</label><br /> <label><input
					type="checkbox" name="lyDoMau" value="Chờ xác nhận lâu" /> Chờ xác
					nhận đơn hàng quá lâu</label><br /> <label><input type="checkbox"
					name="lyDoMau" value="Muốn thay đổi sản phẩm hoặc số lượng" />
					Muốn thay đổi sản phẩm hoặc số lượng nhưng không tiện chỉnh sửa</label><br />
				<label><input type="checkbox" name="lyDoMau"
					value="Phát hiện giá tốt hơn nơi khác" /> Phát hiện giá sản phẩm
					tốt hơn ở nơi khác nên hủy đơn</label><br /> <label><input
					type="checkbox" name="lyDoMau" value="Không còn nhu cầu mua hàng" />
					Không còn nhu cầu mua hàng</label><br /> <label><input
					type="checkbox" name="lyDoMau" value="Khác" id="khacCheckbox" />
					Khác (vui lòng ghi rõ)</label>
			</div>

			<p style="margin-top: 10px;">Ghi chú thêm (nếu có):</p>
			<textarea id="lyDoKhac" rows="3"
				placeholder="Nhập lý do khác nếu có..." style="width: 100%;"></textarea>

			<!-- Ẩn trường thực gửi lên server -->
			<input type="hidden" name="lyDoHuy" id="lyDoHuy" /> <br />
			<button type="submit" class="btn btn-danger">Gửi yêu cầu hủy</button>
		</form>
	</div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const buttons = document.querySelectorAll('.filter .btn');

        buttons.forEach(button => {
            button.addEventListener('click', function (e) {
                // Bỏ class active khỏi tất cả nút
                buttons.forEach(btn => btn.classList.remove('active'));
                
                // Thêm class active vào nút vừa được bấm
                this.classList.add('active');
            });
        });
    });
</script>
<script>
  // Lấy modal, nút đóng và các nút hủy đơn
  const modal = document.getElementById('popupLyDoHuy');
  const closeBtn = modal.querySelector('.close1');
  const maDHInput = document.getElementById('maDHInput');
  const lyDoKhacTextarea = document.getElementById('lyDoKhac');
  const khacCheckbox = document.getElementById('khacCheckbox');
  const checkboxes = modal.querySelectorAll('input[name="lyDoMau"]');

  // Mở modal khi bấm nút hủy đơn
	document.addEventListener("DOMContentLoaded", function () {
	    const btnsHuy = document.querySelectorAll(".btn-huy-don");
	
	    btnsHuy.forEach(btn => {
	        btn.addEventListener("click", function () {
	            // 'this' ở đây sẽ là btn đúng
	            showConfirm("Bạn có chắc chắn muốn hủy đơn hàng này?", () => {
	                const maDH = this.getAttribute('data-madh');
	                maDHInput.value = maDH;
	                checkboxes.forEach(cb => cb.checked = false);
	                lyDoKhacTextarea.value = '';
	                khacCheckbox.checked = false;

	                modal.style.display = 'block';
	            });
	        });
	    });
	});

  closeBtn.addEventListener('click', function () {
    modal.style.display = 'none';
  });


  khacCheckbox.addEventListener('change', function () {
    if (this.checked) {
      lyDoKhacTextarea.style.display = 'block';
      lyDoKhacTextarea.focus();
    } else {
      lyDoKhacTextarea.style.display = 'none';
      lyDoKhacTextarea.value = '';
    }
  });

  lyDoKhacTextarea.style.display = 'none';

  // Hàm xử lý khi submit form: tổng hợp lý do thành 1 chuỗi duy nhất
  function prepareLyDoHuy() {
    let lyDoArr = [];
    checkboxes.forEach(cb => {
      if (cb.checked && cb.value !== 'Khác') {
        lyDoArr.push(cb.value);
      }
    });
    if (khacCheckbox.checked && lyDoKhacTextarea.value.trim() !== '') {
      lyDoArr.push(lyDoKhacTextarea.value.trim());
    }
    if (lyDoArr.length === 0) {
      hienThongBaoHeThong("Vui lòng chọn hoặc nhập lý do hủy đơn", false);
      return false;
    }
    document.getElementById('lyDoHuy').value = lyDoArr.join('; ');
    return true; // cho phép submit form
  }
</script>
<script>
document.querySelectorAll('.buy-again-btn').forEach(btn => {
    btn.addEventListener('click', async function () {
        const maCT = this.dataset.mact;
        const soLuong = parseInt(this.dataset.soluong) || 1;

        try {
            const res = await fetch('/gio-hang/them', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
                },
                body: JSON.stringify({ maCT, soLuong })
            });

            const data = await res.json().catch(() => ({}));

            // Bắt cả khi request lỗi hoặc backend trả thông báo lỗi
            if (!res.ok || data.error) {
                hienThongBaoHeThong(data.error , false);
                return; // ⛔ Dừng, không redirect
            }

            if (data.maCTGH) {
                sessionStorage.setItem('tickNewItem', data.maCTGH);
                window.location.href = '/gio-hang';
            } else {
                alert("❌ Lỗi: không nhận được thông tin sản phẩm vừa thêm");
            }

        } catch (err) {
            alert("⚠️ Vui lòng đăng nhập để mua hàng");
        }
    });
});


</script>