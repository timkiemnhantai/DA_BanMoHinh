<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8" />
<meta name="_csrf" th:content="${_csrf.token}" />
<meta name="_csrf_header" th:content="${_csrf.headerName}" />

<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gundam Shop</title>
<link rel="stylesheet" href="/css/style.css" />

<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>


</head>
<body>
	<!-- menu -->
	<div class="body-nav" id="main-nav">
		<nav id="navbar">
			<div class="nav-logo">
				<div class="stripe blue"></div>
				<div class="stripe yellow"></div>
				<div class="stripe red"></div>

				<div class="logo-wrapper">
					<img src="/img/processed_no_white.png" alt="" />
					<div class="logo-title">Gundam Shop</div>
				</div>
			</div>

			<div class="nav-toolbar">
				<form action="/product" method="get" class="search">
					<div class="search-left">
						<input type="text" name="keyword" th:value="${tuKhoa}"
							placeholder="Từ khóa..." onfocus="this.placeholder=''"
							onblur="this.placeholder='Từ khóa...'" />
					</div>
					<div class="search-right">
						<button type="submit" class="in">
							<img src="/img/search.png" alt="Tìm kiếm" />
						</button>
					</div>
				</form>

				<div class="item">
					<ul>
						<li><a th:href="@{/home}">Trang chủ</a></li>
						<li><a th:href="@{/product}">Sản phẩm</a></li>
						<li><a th:href="@{/product(
						    giamGia=true)}">Hàng
								giảm giá</a></li>
						<li><a th:href="@{/product(loai='Dụng cụ')}">Dụng cụ</a></li>
						<li><a th:href="@{/product(loai='Phụ kiện')}">Phụ kiện</a></li>
						<li><a th:href="@{/ChinhSach}">Chính Sách</a></li>
					</ul>
				</div>
			</div>

			<div class="nav-account">
				<div class="account-left">
					<label for="">Kết nối</label> <a href=""><img
						src="/img/facebook.png" alt="" /></a> <a href=""><img
						src="/img/instagram.png" alt="" /></a>
				</div>
				<div class="account-right">
					<th:block th:if="${session.user != null}">
						<div class="account-container">
							<!-- Avatar có thể click được -->
							<a th:href="@{/TrangCaNhan}" class="anh"> <img
								id="avatar-img" th:src="${session.user.avatar}" alt="Avatar"
								onerror="this.onerror=null; this.src='/img/account.png';">
							</a>
				
							<!-- Dropdown xuất hiện khi hover toàn khối account-container -->
							<div class="account-dropdown">
								<a th:href="@{/TrangCaNhan}">Tài Khoản Của Tôi</a> <a
									th:href="@{/logout}">Đăng Xuất</a>
							</div>
						</div>
					<a class="anh2" id="btnShowThongBao" style="position:relative;display:inline-block;">
					  <img src="/img/notification.png" alt="thông báo">
					  <span id="notifCountBadge" class="notif-badge" style="display:none">0</span>
					</a>


						<a class="anh1" th:href="@{/gio-hang}"><img
							src="/img/Screenshot_2025-06-19_220342-removebg-preview.png"
							alt=""></a>
					</th:block>
					<th:block th:if="${session.user == null}">
						<a class="ngang" th:href="@{/register}">Đăng ký</a> | <a
							class="ngang" th:href="@{/login}">Đăng nhập</a>
					</th:block>

				</div>
			</div>
		</nav>
	</div>
	
	
	<!-- banner -->
	<div th:replace="~{${content}}"></div>

	<!-- Toast container -->
<div id="toast-container" class="toast-container">
   <div th:each="tb : ${dsThongBaoChuaDoc}" 
        class="toast toast-websocket" 
        th:attr="data-id=${tb.maThongBao}"
        style="background-color: rgb(0, 128, 255); color: #fff; border-radius: 8px; margin-bottom: 8px; padding: 12px 16px;">
        
        <div class="toast-content" style="display: flex; justify-content: space-between; align-items: center;">
        	<a th:href="${tb.url}" onclick="return danhDauVaAn(this)">
                <span th:text="${tb.noiDung}"></span>
        	</a>

            <button class="toast-close" style="background: none; border: none; font-size: 18px; color: #fff; cursor: pointer;" 
                    onclick="danhDauVaAn(this)">
                ×
            </button>
        </div>
    </div>
</div>
<div id="toast-container1" class="toast-container"></div>

	<!-- Modal xác nhận -->
	<div id="confirm-modal" class="modal-overlay hidden">
		<div class="modal-content">
			<p id="confirm-message"></p>
			<div class="modal-actions">
				<button id="confirm-yes" class="btn btn-danger">Xác nhận</button>
				<button id="confirm-no" class="btn btn-secondary">Hủy</button>
			</div>
		</div>
	</div>

	<div id="thongBaoForm" style="display:none;">
  <div class="thong-bao-box" id="thongBaoBox">
    <div class="thong-bao-header">
      <h3>Thông báo</h3>
	  <div style="display:flex;gap:8px;align-items:center;">
	    <button id="btnMarkAllRead">Đánh dấu đã đọc</button>
	    <button id="btnClearAll">Xóa hết</button>
	  </div>
    </div>
    <div class="thong-bao-list" id="thongBaoList">
      <div class="thong-bao-item">
        <div>
          <strong></strong>
          <p></p>
        </div>
        <button class="btnDelete">Xóa</button>
      </div>
    </div>
    <div class="thong-bao-footer">
      <button id="btnCloseThongBao">Đóng</button>
    </div>
  </div>
</div>


</body>

<footer class="site-footer">
	<div class="footer-container">
		<div class="footer-column">
			<div class="footer-logo">
				<img src="/img/logo_gundam.png" alt="Gundam Shop Footer Logo" /> <span>Gundam
					Shop</span>
			</div>
			<h4>Liên hệ</h4>
			<p>Địa chỉ: QTSC 9 Building, D. Tố Ký, Tân Chánh Hiệp, Quận 12,
				Hồ Chí Minh</p>
			<p>Hotline: xxxx.xxxx.xxx</p>
			<p>Email: abcyz@gmail.com</p>
		</div>

		<div class="footer-column">
			<h4>Chính sách</h4>
			<ul>
				<li>Chính sách bảo mật</li>
				<li>Chính sách đổi trả</li>
				<li>Chính sách vận chuyển</li>
				<li>Quy định sử dụng</li>
			</ul>
		</div>

		<div class="footer-column payment-shipping-column">
			<h4>Thanh toán</h4>
			<div class="payment-methods">
				<img src="/img/1.png" alt="Visa" /> <img src="/img/2.png"
					alt="Mastercard" /> <img src="/img/3.jpg" alt="JCB" /> <img
					src="/img/4.png" alt="Amex" /> <img src="/img/5.png" alt="QR Code" />
			</div>
			<h4>Đơn vị vận chuyển</h4>
			<div class="shipping-methods">
				<img src="/img/6.png" alt="SPX Express" /> <img src="/img/7.png"
					alt="Giao Hang Tiet Kiem" /> <img src="/img/8.png"
					alt="J&T Express" /> <img src="/img/9.png" alt="Ninja Van" /> <img
					src="/img/12.png" alt="VNPost" /> <img src="/img/10.jpg"
					alt="Giao Hang Nhanh" /> <img src="/img/11.png" alt="Best Express" />
			</div>
		</div>

		<div class="footer-column map-column">
			<h4>Map</h4>
			<img src="/img/google_map.png" alt="Google Map"
				class="footer-map-image" />
		</div>

		<div class="footer-column final-column">
			<h4>Đề tài</h4>
			<p>Website bán hàng mô hình lắp ráp</p>
			<h4>Thành viên</h4>
			<ul>
				<li>Từ Ngọc Sơn</li>
				<li>Trần Phúc Duy Khang</li>
				<li>Võ Trường Giang</li>
				<li>Nguyễn Hoàng Gia Khang</li>
				<li>Phạm Minh Tân</li>
			</ul>
		</div>
	</div>
	
</footer>

<script>
    function danhDauVaAn(element) {
        const toast = element.closest('.toast');
        const id = toast.getAttribute('data-id');
        const isLink = element.tagName === 'A';
        const url = isLink ? element.getAttribute('href') : null;

        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        fetch(`/thong-bao/${id}/da-doc`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken
            }
        }).then(res => {
            if (res.ok) {
                toast.remove();
                if (isLink && url) {
                    window.location.href = url; 
                }
            } else {
                alert('Lỗi khi đánh dấu thông báo đã đọc');
            }
        }).catch(err => {
            console.error('Lỗi fetch:', err);
            alert('Lỗi kết nối máy chủ');
        });

        return false; 
    }
</script>







<script>
    function updatePadding() {
      const navbar = document.getElementById("navbar");
      const mainNav = document.getElementById("main-nav");
      if (navbar && mainNav) {
        mainNav.style.paddingTop = navbar.offsetHeight + "px";
      }
    }

    window.addEventListener("DOMContentLoaded", updatePadding);
    window.addEventListener("resize", updatePadding);

    let lastScrollY = window.scrollY;
    const navbar = document.getElementById("navbar");

    window.addEventListener("scroll", () => {
      const currentScrollY = window.scrollY;

      if (currentScrollY > lastScrollY) {

        navbar.style.transform = "translateY(-100%)";
      } else {

        navbar.style.transform = "translateY(0)";
      }

      lastScrollY = currentScrollY;
    });
    
  </script>
<script>
function hienThongBaoHeThong(message, isSuccess = true) {
	const container = document.getElementById('toast-container1');

	const toast = document.createElement('div');
	toast.classList.add('toast');
	toast.style.backgroundColor = isSuccess ? '#28a745' : '#dc3545'; // xanh nếu thành công, đỏ nếu lỗi
	toast.textContent = message;

	container.appendChild(toast);

	setTimeout(() => {
		toast.remove();
	}, 4000);
}

document.addEventListener("DOMContentLoaded", () => {
    const msg = sessionStorage.getItem('thongBaoDanhGia');
    if(msg) {
        hienThongBaoHeThong(msg, true);
        sessionStorage.removeItem('thongBaoDanhGia'); // xóa sau khi hiển thị
    }
});



function hienThongBao(noiDung, maThongBao, url) {
    console.log("Nhận thông báo:", noiDung, maThongBao, url);
    const container = document.getElementById('toast-container');

    const toast = document.createElement("div");
    toast.className = "toast toast-websocket";
    toast.style.backgroundColor = "rgb(0, 128, 255)";
    toast.style.color = "#fff";
    toast.style.borderRadius = "8px";
    toast.style.marginBottom = "8px";
    toast.style.padding = "12px 16px";

    toast.setAttribute("data-id", maThongBao);
    toast.setAttribute("data-url", url);
    toast.innerHTML = `
        <div class="toast-content" style="display: flex; justify-content: space-between; align-items: center;">
            <span>${noiDung}</span>
            <button class="toast-close" style="background: none; border: none; font-size: 18px; color: #fff; cursor: pointer;">×</button>
        </div>
    `;

    toast.querySelector(".toast-close").addEventListener("click", function (e) {
        e.stopPropagation();

        const id = toast.getAttribute("data-id");
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        fetch(`/thong-bao/${id}/da-doc`, {
            method: 'POST',
            headers: {
                [csrfHeader]: csrfToken
            }
        }).then(res => {
            if (res.ok) toast.remove();
            else alert("Lỗi khi đánh dấu đã đọc!");
        }).catch(err => {
            console.error(err);
            alert("Lỗi kết nối máy chủ");
        });
    });

    toast.addEventListener("click", () => {
        console.log("Click toast, url =", toast.getAttribute("data-url"));
        const id = toast.getAttribute("data-id");
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        const url = toast.getAttribute('data-url'); // lấy url từ attribute

        fetch(`/thong-bao/${id}/da-doc`, {
            method: 'POST',
            headers: {
                [csrfHeader]: csrfToken
            }
        }).finally(() => {
            if (url) {
                window.location.href = url;
            }
        });
    });


    container.appendChild(toast);
}






  function showConfirm(message, onConfirm) {
	  const modal = document.getElementById("confirm-modal");
	  const messageEl = document.getElementById("confirm-message");
	  const yesBtn = document.getElementById("confirm-yes");
	  const noBtn = document.getElementById("confirm-no");

	  messageEl.textContent = message;
	  modal.classList.remove("hidden");

	  const close = () => modal.classList.add("hidden");

	  yesBtn.onclick = () => {
	    close();
	    onConfirm();
	  };
	  noBtn.onclick = close;
	}
  
</script>
<!-- Thêm đoạn này trong TrangCaNhan.html -->
<script th:inline="javascript">
    /*<![CDATA[*/
    let error = /*[[${error}]]*/ null;
    let success = /*[[${success}]]*/ null;
    /*]]>*/
</script>

<script>
/* ---------- CSRF helper ---------- */
function getCsrf() {
  const tokenMeta = document.querySelector('meta[name="_csrf"]');
  const headerMeta = document.querySelector('meta[name="_csrf_header"]');
  return {
    header: headerMeta ? headerMeta.getAttribute('content') : 'X-CSRF-TOKEN',
    token: tokenMeta ? tokenMeta.getAttribute('content') : ''
  };
}

/* ---------- UI helpers (badge, toast) ---------- */
const badgeEl = document.getElementById('notifCountBadge');
function setNotifBadge(count) {
  if (!badgeEl) return;
  const n = Number(count || 0);
  if (n <= 0) {
    badgeEl.style.display = 'none';
    badgeEl.textContent = '0';
  } else {
    badgeEl.style.display = 'inline-block';
    badgeEl.textContent = (n > 99 ? '99+' : String(n));
  }
}
function changeNotifDelta(delta) {
  if (!badgeEl) return;
  const curr = badgeEl.style.display === 'none' ? 0 : parseInt(badgeEl.textContent.replace(/\D/g, '') || '0', 10);
  setNotifBadge(Math.max(0, (curr || 0) + (delta || 0)));
}


/* ---------- small helpers ---------- */
function escapeHtml(unsafe){
  if (unsafe == null) return '';
  return String(unsafe)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}
function formatDateTime(iso) {
  if(!iso) return '';
  try { return new Date(iso).toLocaleString('vi-VN', { hour12:false }); }
  catch(e){ return iso; }
}
function renderEmptyState() {
  const list = document.getElementById('thongBaoList');
  if (!list) return;

  const hasItems = Array.from(list.children).some(ch => ch.classList && ch.classList.contains('thong-bao-item'));
  if (!hasItems) {
    list.innerHTML = `<div class="thong-bao-empty">Chưa có thông báo nào</div>`;
  } else {

    const empty = list.querySelector('.thong-bao-empty');
    if (empty) empty.remove();
  }
}

/* ---------- API calls ---------- */
async function fetchLatestNotifications(limit=20) {
  try {
    if(!maTK || maTK <= 0) return { unread:0, items:[] };
    const res = await fetch(`/api/thong-bao/latest?maTK=${encodeURIComponent(maTK)}&limit=${encodeURIComponent(limit)}`);
    if(!res.ok) return { unread:0, items:[] };
    return await res.json();
  } catch (e) {
    console.warn('fetchLatestNotifications err', e);
    return { unread:0, items:[] };
  }
}

async function markSingleAsRead(maThongBao) {
  try {
    const { header, token } = getCsrf();
    const res = await fetch(`/api/thong-bao/${encodeURIComponent(maThongBao)}/read`, {
      method: 'POST',
      headers: { [header]: token }
    });
    if (!res.ok && res.status !== 204) {
      console.warn('markSingleAsRead failed', res.status);
      return false;
    }
    const el = document.querySelector(`.thong-bao-item[data-id="${maThongBao}"]`);
    if (el && el.classList.contains('unread')) {
      el.classList.remove('unread'); el.classList.add('read');
      changeNotifDelta(-1);
    }
    const toast = document.querySelector(`#toast-container .toast-websocket[data-id="${maThongBao}"]`);
    if (toast) toast.remove();
    return true;
  } catch (e) {
    console.error('markSingleAsRead err', e);
    return false;
  }
}

async function markAllAsReadServer() {
	  showConfirm('Đánh dấu tất cả thông báo là đã đọc?', async () => {
	    try {
	      const { header, token } = getCsrf();
	      const res = await fetch(`/api/thong-bao/mark-all-read?maTK=${encodeURIComponent(maTK)}`, {
	        method: 'POST',
	        headers: { [header]: token }
	      });
	      if (!res.ok && res.status !== 204) {
	        throw new Error('Server trả lỗi ' + res.status);
	      }
	      document.querySelectorAll('.thong-bao-item.unread').forEach(el => {
	        el.classList.remove('unread');
	        el.classList.add('read');
	      });
	      document.querySelectorAll('#toast-container .toast-websocket').forEach(t => t.remove());
	      setNotifBadge(0);
	      hienThongBaoHeThong('Đã đánh dấu tất cả là đã đọc', true);
	    } catch (e) {
	      console.error(e);
	      alert('Đánh dấu tất cả thất bại. Kiểm tra console.');
	    }
	  });
	}

async function deleteNotificationOnServer(maThongBao) {
	  showConfirm('Xóa thông báo này?', async () => {
	    try {
	      const { header, token } = getCsrf();
	      const res = await fetch(`/api/thong-bao/${encodeURIComponent(maThongBao)}`, {
	        method: 'DELETE',
	        headers: { [header]: token }
	      });
	      if (!res.ok && res.status !== 204) throw new Error('Server trả lỗi ' + res.status);
	      const el = document.querySelector(`.thong-bao-item[data-id="${maThongBao}"]`);
	      if (el) el.remove();
	      renderEmptyState();
	      const toast = document.querySelector(`#toast-container .toast-websocket[data-id="${maThongBao}"]`);
	      if (toast) toast.remove();
	      const fresh = await fetchLatestNotifications(0);
	      setNotifBadge(fresh.unread || 0);
	      hienThongBaoHeThong('Đã xóa thông báo', true);
	      if (window.thongBaoCache) delete window.thongBaoCache[String(maThongBao)];
	    } catch (e) {
	      console.error(e);
	      alert('Xóa thất bại. Kiểm tra console.');
	    }
	  });
	}

async function deleteAllNotificationsOnServer() {
	  showConfirm('Xóa tất cả thông báo?', async () => {
	    try {
	      const { header, token } = getCsrf();
	      const res = await fetch(`/api/thong-bao/delete-all?maTK=${encodeURIComponent(maTK)}`, {
	        method: 'DELETE',
	        headers: { [header]: token }
	      });
	      if (!res.ok && res.status !== 204) throw new Error('Server trả lỗi ' + res.status);
	      document.querySelectorAll('.thong-bao-item').forEach(n => n.remove());
	      renderEmptyState();
	      document.querySelectorAll('#toast-container .toast-websocket').forEach(n => n.remove());
	      setNotifBadge(0);
	      if (window.thongBaoCache) window.thongBaoCache = {};
	      hienThongBaoHeThong('Đã xóa tất cả thông báo', true);
	    } catch (e) {
	      console.error(e);
	      alert('Xóa tất cả thất bại. Kiểm tra console.');
	    }
	  });
	}

/* ---------- render item ---------- */
function makeThongBaoItem(tb) {
  const div = document.createElement('div');
  div.className = 'thong-bao-item' + (tb.daDoc ? ' read' : ' unread');
  div.dataset.id = tb.maThongBao;
  div.style.display = 'flex';
  div.style.justifyContent = 'space-between';
  div.style.alignItems = 'center';
  div.style.padding = '8px';
  div.innerHTML = `
    <div style="flex:1; cursor:pointer;" class="thong-bao-body">
      <strong>${escapeHtml(tb.tieuDe || '')}</strong>
      <p style="margin:4px 0 6px 0; color:#333;">${escapeHtml(tb.noiDung || '')}</p>
      <small style="color:#777">${formatDateTime(tb.ngayTao)}</small>
    </div>
    <div style="margin-left:12px; display:flex; flex-direction:column; gap:6px; align-items:flex-end;">
      <button class="btnMarkSingle" title="Đánh dấu đã đọc">✓</button>
      <button class="btnDelete" title="Xóa">Xóa</button>
    </div>
  `;
  div.querySelector('.thong-bao-body').addEventListener('click', async (ev) => {
    ev.stopPropagation();
    await markSingleAsRead(tb.maThongBao);
    if (tb.url) window.location.href = tb.url;
  });
  div.querySelector('.btnMarkSingle').addEventListener('click', async (ev) => {
    ev.stopPropagation();
    await markSingleAsRead(tb.maThongBao);
  });
  div.querySelector('.btnDelete').addEventListener('click', (ev) => {
    ev.stopPropagation();
    deleteNotificationOnServer(tb.maThongBao);
  });
  return div;
}

/* ---------- open modal / render list ---------- */
const thongBaoForm = document.getElementById('thongBaoForm');
const thongBaoList = document.getElementById('thongBaoList');
const btnShowThongBao = document.getElementById('btnShowThongBao');

async function openThongBaoBox() {
  if (!thongBaoForm || !thongBaoList) return;
  thongBaoForm.style.display = 'block';
  const data = await fetchLatestNotifications(50);
  const items = Array.isArray(data.items) ? data.items.slice() : [];
  items.sort((a,b) => {
    const aUnread = a.daDoc ? 1 : 0;
    const bUnread = b.daDoc ? 1 : 0;
    if (aUnread !== bUnread) return aUnread - bUnread; // unread first
    return (new Date(b.ngayTao || 0)).getTime() - (new Date(a.ngayTao || 0)).getTime();
  });
  thongBaoList.innerHTML = '';
  items.forEach(tb => thongBaoList.appendChild(makeThongBaoItem(tb)));
  renderEmptyState();
  setNotifBadge(data.unread || 0);
}

/* ---------- wire UI buttons ---------- */
document.addEventListener('DOMContentLoaded', function(){
  fetchLatestNotifications(0).then(data => setNotifBadge(data.unread || 0)).catch(()=>{});

  if (btnShowThongBao) btnShowThongBao.addEventListener('click', openThongBaoBox);
  const btnClose = document.getElementById('btnCloseThongBao');
  if (btnClose) btnClose.addEventListener('click', ()=> thongBaoForm.style.display = 'none');

  const btnClearAll = document.getElementById('btnClearAll');
  if (btnClearAll) btnClearAll.addEventListener('click', deleteAllNotificationsOnServer);

  const btnMarkAllRead = document.getElementById('btnMarkAllRead');
  if (btnMarkAllRead) btnMarkAllRead.addEventListener('click', markAllAsReadServer);

  if (thongBaoForm) {
    thongBaoForm.addEventListener('click', function(e){
      if (e.target === thongBaoForm) {
        thongBaoForm.style.display = 'none';
      }
    });
  }
});

/* ---------- websocket: nhận notif mới realtime ---------- */
if (maTK > 0) {
  const socket = new SockJS("/ws");
  const stompClient = Stomp.over(socket);
  stompClient.connect({}, function () {
    stompClient.subscribe("/topic/thong-bao/" + maTK, async function (message) {
      try {
        const data = JSON.parse(message.body || '{}');
        await processIncomingNotification(data);
      } catch(err) {
        console.error('Lỗi xử lý notification từ websocket', err);
      }
    });
  }, function(err){
    console.warn('STOMP connect error', err);
  });
}

</script>
<script>
  document.getElementById('btnShowThongBao').addEventListener('click', () => {
    document.getElementById('thongBaoForm').style.display = 'block';
  });

  document.getElementById('btnCloseThongBao').addEventListener('click', () => {
    document.getElementById('thongBaoForm').style.display = 'none';
  });
</script>




<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script th:inline="javascript">
/*<![CDATA[*/
const maTK = /*[[${session.user != null ? session.user.maTK : 0}]]*/ 0;

function ensureNotifUiReady() {
  window.thongBaoCache = window.thongBaoCache || {}; 
  window.isThongBaoListReady = !!document.getElementById('thongBaoList');
}

function addNotificationToList(tb){
	  if(!tb || !tb.maThongBao) return;
	  const id = String(tb.maThongBao);

	  window.thongBaoCache = window.thongBaoCache || {};

	  if (window.thongBaoCache[id]) return;
	  if (document.querySelector(`.thong-bao-item[data-id="${id}"]`)) {
	    window.thongBaoCache[id] = tb; 
	    return;
	  }

	  const list = document.getElementById('thongBaoList');
	  if (!list) {

	    window.pendingNotifications = window.pendingNotifications || [];
	    window.pendingNotifications.push(tb);
	    scheduleFlushPending && scheduleFlushPending();
	    return;
	  }

	  const empty = list.querySelector('.thong-bao-empty');
	  if (empty) empty.remove();

	  const node = makeThongBaoItem(tb);
	  list.insertBefore(node, list.firstChild);

	  window.thongBaoCache[id] = tb;
	}

async function processIncomingNotification(data){
	  if (!data) return;
	  let tbObj = data;

	  if (!data.tieuDe && data.maThongBao) {
	    try {
	      const res = await fetch(`/api/thong-bao/latest?maTK=${encodeURIComponent(maTK)}&limit=10`);
	      if (res.ok) {
	        const json = await res.json();
	        const items = Array.isArray(json.items) ? json.items : [];
	        tbObj = items.find(it => String(it.maThongBao) === String(data.maThongBao)) || data;
	      }
	    } catch (e) {
	      console.warn('Fetch detail fail, using payload', e);
	    }
	  }

	  const id = String(tbObj.maThongBao);
	  if (window.thongBaoCache && window.thongBaoCache[id]) return;

	  addNotificationToList(tbObj);

	  if (!tbObj.daDoc) {
	    changeNotifDelta(1);
	  }

	  try {
	    if (typeof hienThongBao === 'function') {
	      hienThongBao(tbObj.noiDung || tbObj.tieuDe || '', tbObj.maThongBao, tbObj.url || '');
	    }
	  } catch (e) { console.warn(e); }
	}
if (maTK > 0) {
  const socket = new SockJS("/ws");
  const stompClient = Stomp.over(socket);
  stompClient.connect({}, function () {
    stompClient.subscribe("/topic/thong-bao/" + maTK, async function (message) {
      try {
        const data = JSON.parse(message.body);
        await processIncomingNotification(data);
      } catch(err) {
        console.error('Lỗi xử lý notification từ websocket', err);
      }
    });
  }, function(err){
    console.warn('STOMP connect error', err);
  });
}
/*]]>*/
</script>


<!-- Ionicons: để hiển thị icon trong form -->
<script type="module"
	src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule
	src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</html>